<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Rendering Pipeline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Basic glassmorphic styling */
    * {
      margin: 0; padding: 0; box-sizing: border-box;
    }
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
    }
    .container {
      max-width: 600px;
      margin: 80px auto;
      padding: 20px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.07);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      position: relative;
    }
    .container::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 16px;
      background: linear-gradient(
        145deg,
        rgba(255,255,255,0.4) 0%,
        rgba(255,255,255,0) 41%,
        rgba(255,255,255,0) 57%,
        rgba(255,255,255,0.4) 100%
      );
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
      font-weight: 500;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      color: #ccc;
      font-size: 0.95rem;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #444;
      background: rgba(255,255,255,0.1);
      outline: none;
      color: #fff;
      font-size: 1rem;
    }
    /* Custom styling for the dropdown menu (containerName) */
    #containerName {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,<svg fill='%23fff' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px;
      padding-right: 40px; /* extra space for the arrow */
    }
    button {
      background: #FF4F00;
      border: none;
      padding: 10px 20px;
      border-radius: 999px;
      cursor: pointer;
      color: #fff;
      font-size: 1rem;
      transition: opacity 0.2s;
    }
    button:hover {
      opacity: 0.9;
    }
    #logs {
      margin-top: 24px;
      color: #ccc;
      font-size: 0.9rem;
      white-space: pre-wrap; /* So newlines are preserved */
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>3D Rendering Pipeline</h1>
    <div class="form-group">
      <label for="archiveName">S3 Archive/File Name (in user-submissions bucket):</label>
      <input type="text" id="archiveName" placeholder="e.g. 1742105708797-13zf5v-Archive.zip" />
    </div>
    <div class="form-group">
      <label for="containerName">Container Name (ECR repository):</label>
      <select id="containerName">
        <option value="nerfstudio" selected>nerfstudio</option>
        <!-- If you have more ECR repos, list them here -->
      </select>
    </div>
    <button id="startBtn">Start Training</button>
    <div id="logs"></div>
  </div>

  <script>
    const API_GATEWAY_URL = "https://REPLACE_ME.execute-api.us-west-2.amazonaws.com/prod";

    let currentJobId = null;
    let pollingTimer = null;

    document.getElementById("startBtn").addEventListener("click", async () => {
      // Clear logs each time we start
      const logsEl = document.getElementById("logs");
      logsEl.innerText = "Starting training job...\n";

      const archiveName = document.getElementById("archiveName").value.trim();
      const containerName = document.getElementById("containerName").value;

      // Build JSON payload
      const payload = {
        s3ArchiveName: archiveName,
        containerName: containerName
      };

      try {
        // POST request to /start
        const response = await fetch(`${API_GATEWAY_URL}/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`Error: ${response.statusText}`);
        }

        const data = await response.json();
        logsEl.innerText += `Job started!\nJob ID: ${data.jobId}\n` +
          `Container Used: ${data.containerUsed}\n` +
          `Input Data: ${data.inputData}\n\n` +
          `Now polling logs...\n`;

        currentJobId = data.jobId;

        // Start polling /logs with the jobId
        if (pollingTimer) {
          clearInterval(pollingTimer);
        }
        pollingTimer = setInterval(pollLogs, 10000); // poll every 10s
      } catch (err) {
        logsEl.innerText += `Failed to start job: ${err.message}\n`;
      }
    });

    async function pollLogs() {
      if (!currentJobId) return;
      const logsEl = document.getElementById("logs");

      logsEl.innerText += `\nPolling logs for jobId: ${currentJobId}...\n`;

      try {
        // GET request to /logs?jobId=xxx
        const response = await fetch(`${API_GATEWAY_URL}/logs?jobId=${currentJobId}`);
        if (!response.ok) {
          throw new Error(`Logs Error: ${response.statusText}`);
        }

        const data = await response.json();
        logsEl.innerText += `DB Status: ${data.dbStatus}\n`;
        
        if (data.sageMakerJobDescription) {
          const smStatus = data.sageMakerJobDescription.TrainingJobStatus || "Unknown";
          const smSecStatus = data.sageMakerJobDescription.SecondaryStatus || "Unknown";
          logsEl.innerText += `SageMaker TrainingJobStatus: ${smStatus}\n`;
          logsEl.innerText += `SageMaker SecondaryStatus: ${smSecStatus}\n`;
        }
      } catch (err) {
        logsEl.innerText += `Error polling logs: ${err.message}\n`;
      }
    }
  </script>

</body>
</html>
